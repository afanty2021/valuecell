# 策略组合周期

<cite>
**本文档引用的文件**   
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py)
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py)
- [strategy.py](file://python/valuecell/server/api/routers/strategy.py)
- [plan.py](file://python/valuecell/core/plan/planner.py)
- [service.py](file://python/valuecell/core/plan/service.py)
- [strategy-compose-list.tsx](file://frontend/src/app/agent/components/strategy-items/strategy-compose-list.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [核心数据模型](#核心数据模型)
3. [周期事件记录机制](#周期事件记录机制)
4. [自动化策略优化](#自动化策略优化)
5. [周期状态跟踪与历史分析](#周期状态跟踪与历史分析)
6. [与计划服务集成](#与计划服务集成)
7. [数据存储与查询优化](#数据存储与查询优化)

## 简介
策略组合周期（StrategyComposeCycle）模型是ValueCell系统中用于记录和管理策略周期性重组事件的核心组件。该模型通过结构化的数据记录，追踪策略在运行过程中的每一次重组，为策略的自动化优化、性能分析和历史回溯提供了坚实的基础。每个重组周期都包含详细的元数据，如触发原因、性能指标和时间戳，使得系统能够基于市场条件或预设的性能阈值自动触发重组，从而实现策略的动态调整和持续优化。

## 核心数据模型
策略组合周期模型定义了记录策略重组事件所需的核心字段，包括唯一标识、时间戳、索引和可选的推理信息。

```mermaid
classDiagram
class StrategyComposeCycle {
+int id
+str strategy_id
+str compose_id
+datetime compose_time
+int cycle_index
+str rationale
+datetime created_at
+datetime updated_at
}
StrategyComposeCycle --> Strategy : "belongs to"
```

**图表来源**
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L20-L75)

**本节来源**
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L1-L76)

## 周期事件记录机制
该机制负责捕获和持久化策略的每一次重组事件，确保所有关键信息都被准确记录。

```mermaid
sequenceDiagram
participant Coordinator as "协调器"
participant Persistence as "持久化服务"
participant Repository as "存储库"
participant Database as "数据库"
Coordinator->>Persistence : persist_compose_cycle()
Persistence->>Repository : add_compose_cycle()
Repository->>Database : INSERT INTO strategy_compose_cycles
Database-->>Repository : 返回记录
Repository-->>Persistence : 返回策略组合周期
Persistence-->>Coordinator : 返回成功状态
Note over Coordinator,Database : 记录策略重组周期事件
```

**图表来源**
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L382-L409)

**本节来源**
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L382-L409)

## 自动化策略优化
系统利用策略组合周期模型实现自动化优化，根据预设条件或市场变化自动触发策略重组。

```mermaid
flowchart TD
Start([开始]) --> CheckMarket["检查市场条件"]
CheckMarket --> MarketChange{"市场条件变化?"}
MarketChange --> |是| TriggerRecompose["触发策略重组"]
MarketChange --> |否| CheckPerformance["检查性能指标"]
CheckPerformance --> PerformanceDrop{"性能低于阈值?"}
PerformanceDrop --> |是| TriggerRecompose
PerformanceDrop --> |否| NoAction["无需操作"]
TriggerRecompose --> RecordCycle["记录新周期事件"]
RecordCycle --> UpdateStrategy["更新策略配置"]
UpdateStrategy --> End([结束])
style TriggerRecompose fill:#f9f,stroke:#333
style RecordCycle fill:#f9f,stroke:#333
```

**图表来源**
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)

**本节来源**
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)

## 周期状态跟踪与历史分析
该功能支持对策略周期的完整生命周期进行跟踪，并提供历史数据分析能力，以支持策略的迭代优化。

```mermaid
erDiagram
STRATEGY_COMPOSE_CYCLE {
int id PK
string strategy_id FK
string compose_id
datetime compose_time
int cycle_index
text rationale
datetime created_at
datetime updated_at
}
STRATEGY_DETAIL {
int id PK
string strategy_id FK
string compose_id FK
string trade_id
string symbol
float realized_pnl
float realized_pnl_pct
}
STRATEGY_INSTRUCTION {
int id PK
string strategy_id FK
string compose_id FK
string instruction_id
string symbol
string action
float quantity
}
STRATEGY_COMPOSE_CYCLE ||--o{ STRATEGY_DETAIL : "包含"
STRATEGY_COMPOSE_CYCLE ||--o{ STRATEGY_INSTRUCTION : "包含"
```

**图表来源**
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L20-L75)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L448-L467)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)

**本节来源**
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L20-L75)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L448-L467)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)

## 与计划服务集成
策略组合周期模型与计划服务（PlanService）深度集成，能够将自然语言指令转换为具体的周期重组任务。

```mermaid
sequenceDiagram
participant User as "用户"
participant PlanService as "计划服务"
participant Planner as "规划器"
participant StrategyService as "策略服务"
User->>PlanService : 提交自然语言指令
PlanService->>Planner : create_plan()
Planner->>Planner : 分析指令并生成执行计划
Planner-->>PlanService : 返回执行计划
PlanService->>StrategyService : 执行重组任务
StrategyService->>StrategyService : persist_compose_cycle()
StrategyService-->>PlanService : 返回结果
PlanService-->>User : 返回最终响应
Note over User,PlanService : 将自然语言转换为周期重组任务
```

**图表来源**
- [service.py](file://python/valuecell/core/plan/service.py#L87-L112)
- [planner.py](file://python/valuecell/core/plan/planner.py#L132-L174)
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)

**本节来源**
- [service.py](file://python/valuecell/core/plan/service.py#L87-L112)
- [planner.py](file://python/valuecell/core/plan/planner.py#L132-L174)
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py#L304-L334)

## 数据存储与查询优化
针对大规模周期数据，系统实施了高效的存储和查询优化策略，确保性能和可扩展性。

```mermaid
graph TD
A[应用层] --> B[服务层]
B --> C[存储库层]
C --> D[数据库层]
subgraph "数据库层"
D --> E[(策略组合周期表)]
E --> F["索引: strategy_id, compose_id"]
E --> G["索引: compose_time"]
E --> H["唯一约束: uq_strategy_compose_cycle"]
end
subgraph "存储库层"
C --> I["批量查询: get_cycles()"]
C --> J["分页支持"]
C --> K["缓存策略"]
end
subgraph "服务层"
B --> L["数据聚合"]
B --> M["性能指标计算"]
B --> N["历史分析"]
end
style E fill:#f96,stroke:#333
style F fill:#bbf,stroke:#333
style G fill:#bbf,stroke:#333
```

**图表来源**
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L448-L467)
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L62-L64)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)

**本节来源**
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py#L448-L467)
- [strategy_compose_cycle.py](file://python/valuecell/server/db/models/strategy_compose_cycle.py#L62-L64)
- [strategy_service.py](file://python/valuecell/server/services/strategy_service.py#L303-L414)