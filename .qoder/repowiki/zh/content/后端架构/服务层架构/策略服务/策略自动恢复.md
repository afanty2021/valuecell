# 策略自动恢复

<cite>
**本文档引用的文件**   
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py)
- [strategy.py](file://python/valuecell/server/db/models/strategy.py)
- [strategy_repository.py](file://python/valuecell/server/db/repositories/strategy_repository.py)
- [models.py](file://python/valuecell/agents/common/trading/models.py)
- [strategy_persistence.py](file://python/valuecell/server/services/strategy_persistence.py)
- [app.py](file://python/valuecell/server/api/app.py)
</cite>

## 目录
1. [策略自动恢复机制概述](#策略自动恢复机制概述)
2. [自动恢复流程分析](#自动恢复流程分析)
3. [核心组件详细分析](#核心组件详细分析)
4. [异常处理与隔离机制](#异常处理与隔离机制)
5. [防重复执行机制](#防重复执行机制)
6. [系统集成与启动流程](#系统集成与启动流程)

## 策略自动恢复机制概述

策略自动恢复机制是ValueCell系统中的关键功能，旨在确保在系统重启或崩溃后，能够自动恢复正在运行的交易策略。该机制通过扫描数据库中状态为'running'或因取消而停止的策略，并自动恢复其执行。此功能确保了交易策略的连续性和可靠性，即使在系统故障的情况下也能保持策略的持续运行。

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L1-L20)

## 自动恢复流程分析

策略自动恢复机制在系统启动时执行，其核心流程包括扫描数据库、判断恢复条件、重建策略配置和重新调度执行。该机制通过`auto_resume_strategies`函数实现，该函数在系统启动时被调用，负责扫描数据库中符合条件的策略并恢复其执行。

```mermaid
flowchart TD
Start([系统启动]) --> ScanDB["扫描数据库中状态为'running'或'stopped'的策略"]
ScanDB --> Filter["过滤符合条件的策略"]
Filter --> CheckStatus{"策略状态为'running'?"}
CheckStatus --> |是| Resume["恢复策略执行"]
CheckStatus --> |否| CheckStopReason{"状态为'stopped'且停止原因为'cancelled'?"}
CheckStopReason --> |是| Resume
CheckStopReason --> |否| Skip["跳过该策略"]
Resume --> Rebuild["重建UserRequest对象"]
Rebuild --> Inject["注入策略ID"]
Inject --> Reschedule["通过AgentOrchestrator重新调度执行"]
Reschedule --> End([恢复完成])
Skip --> End
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)

## 核心组件详细分析

### auto_resume_strategies函数分析

`auto_resume_strategies`函数是策略自动恢复机制的核心，负责在系统启动时扫描数据库并恢复符合条件的策略。该函数接收一个`AgentOrchestrator`实例作为参数，并可选地限制恢复的策略数量。

```mermaid
sequenceDiagram
participant System as "系统启动"
participant AutoResume as "auto_resume_strategies"
participant Repo as "策略仓库"
participant Resume as "_resume_one"
participant Orchestrator as "AgentOrchestrator"
System->>AutoResume : 调用auto_resume_strategies
AutoResume->>AutoResume : 检查_AUTORESUME_STARTED标志
AutoResume->>Repo : list_strategies_by_status
Repo-->>AutoResume : 返回策略列表
AutoResume->>AutoResume : 过滤可恢复的策略
AutoResume->>AutoResume : 为每个可恢复策略创建任务
loop 每个可恢复策略
AutoResume->>Resume : 创建异步任务
Resume->>Resume : 解析策略配置
Resume->>Resume : 注入策略ID
Resume->>Orchestrator : process_user_input
Orchestrator-->>Resume : 流式响应
Resume->>Resume : 更新策略状态
end
AutoResume->>AutoResume : 等待所有任务完成
AutoResume-->>System : 恢复完成
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)

### _should_resume判断逻辑分析

`_should_resume`函数负责判断一个策略是否应该被自动恢复。该函数实现了双重校验机制，既检查策略状态又检查停止原因。

```mermaid
flowchart TD
Start([开始]) --> GetStatus["获取策略状态"]
GetStatus --> ParseStatus["解析为StrategyStatus枚举"]
ParseStatus --> CheckValid{"状态有效?"}
CheckValid --> |否| ReturnFalse["返回False"]
CheckValid --> |是| CheckRunning{"状态为RUNNING?"}
CheckRunning --> |是| ReturnTrue["返回True"]
CheckRunning --> |否| CheckStopped{"状态为STOPPED?"}
CheckStopped --> |否| ReturnFalse
CheckStopped --> |是| GetMetadata["获取策略元数据"]
GetMetadata --> GetStopReason["获取停止原因"]
GetStopReason --> CheckCancelled{"停止原因为CANCELLED?"}
CheckCancelled --> |是| ReturnTrue
CheckCancelled --> |否| ReturnFalse
ReturnTrue --> End([结束])
ReturnFalse --> End
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L130-L149)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L130-L149)

### _resume_one函数分析

`_resume_one`函数负责将持久化的策略配置重建为`UserRequest`对象，并通过`AgentOrchestrator`重新调度执行。该函数实现了策略ID的注入机制，确保恢复执行时能正确关联到原有的投资组合状态。

```mermaid
sequenceDiagram
participant Resume as "_resume_one"
participant Request as "UserRequest"
participant Input as "UserInput"
participant Orchestrator as "AgentOrchestrator"
participant Persistence as "strategy_persistence"
Resume->>Resume : 获取策略配置和元数据
Resume->>Request : model_validate(config_dict)
Request-->>Resume : UserRequest对象
Resume->>Resume : 检查并注入策略ID
Resume->>Input : 创建UserInput对象
Input-->>Resume : UserInput实例
Resume->>Orchestrator : process_user_input(user_input)
loop 流式响应
Orchestrator-->>Resume : 响应块
Resume->>Resume : 记录调试信息
Resume->>Resume : 检查组件生成事件
Resume->>Persistence : 更新策略状态
Resume->>Resume : 返回
end
Resume->>Resume : 记录异常
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L85-L127)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L85-L127)

## 异常处理与隔离机制

策略自动恢复机制实现了完善的异常处理与隔离机制，确保单个策略恢复失败不会影响其他策略的恢复过程。该机制通过`try-catch`块捕获异常，并将异常信息记录到日志中，同时继续处理其他策略。

```mermaid
flowchart TD
Start([开始恢复策略]) --> ProcessOne["处理单个策略"]
ProcessOne --> Try["try块"]
Try --> Execute["执行恢复逻辑"]
Execute --> Success{"成功?"}
Success --> |是| Next["处理下一个策略"]
Success --> |否| Catch["catch块"]
Catch --> LogError["记录异常信息"]
LogError --> Continue["继续处理其他策略"]
Next --> CheckMore{"还有更多策略?"}
CheckMore --> |是| ProcessOne
CheckMore --> |否| End([所有策略处理完成])
Continue --> CheckMore
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L84-L127)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L84-L127)

## 防重复执行机制

策略自动恢复机制通过全局标志`_AUTORESUME_STARTED`实现防重复执行机制。该标志确保`auto_resume_strategies`函数在整个应用生命周期中只执行一次，防止因多次调用而导致的重复恢复问题。

```mermaid
flowchart TD
Start([调用auto_resume_strategies]) --> CheckFlag["检查_AUTORESUME_STARTED标志"]
CheckFlag --> IsStarted{"标志为True?"}
IsStarted --> |是| Return["直接返回"]
IsStarted --> |否| SetFlag["设置标志为True"]
SetFlag --> Execute["执行恢复逻辑"]
Execute --> End([恢复完成])
Return --> End
```

**Diagram sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L42-L58)

**Section sources**
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L42-L58)

## 系统集成与启动流程

策略自动恢复机制与系统启动流程紧密集成，确保在系统启动时自动执行。该机制通过在应用启动时调用`auto_resume_strategies`函数来实现，确保所有符合条件的策略都能在系统重启后自动恢复执行。

```mermaid
sequenceDiagram
participant System as "系统启动"
participant App as "create_app"
participant Lifespan as "lifespan"
participant Init as "init_database"
participant AutoResume as "auto_resume_strategies"
participant Orchestrator as "AgentOrchestrator"
System->>App : 启动应用
App->>Lifespan : 调用lifespan
Lifespan->>Init : 初始化数据库
Init-->>Lifespan : 初始化完成
Lifespan->>AutoResume : 调用auto_resume_strategies
AutoResume->>AutoResume : 检查防重复标志
AutoResume->>AutoResume : 扫描数据库
AutoResume->>AutoResume : 过滤可恢复策略
loop 每个可恢复策略
AutoResume->>AutoResume : 创建恢复任务
AutoResume->>Orchestrator : 调度执行
end
AutoResume-->>Lifespan : 恢复完成
Lifespan-->>App : 启动完成
App-->>System : 系统就绪
```

**Diagram sources**
- [app.py](file://python/valuecell/server/api/app.py#L91-L141)
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)

**Section sources**
- [app.py](file://python/valuecell/server/api/app.py#L91-L141)
- [strategy_autoresume.py](file://python/valuecell/server/services/strategy_autoresume.py#L45-L83)